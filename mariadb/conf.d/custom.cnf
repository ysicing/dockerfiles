# MariaDB Custom Configuration
# 自定义优化配置

[mysqld]
# ============================================
# 字符集设置
# ============================================
# 使用 utf8mb4 支持完整 Unicode（包括 emoji）
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# ============================================
# 慢查询日志 - 用于发现性能问题
# ============================================
# 开启慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
# 超过 2 秒的查询记录到慢日志
long_query_time = 2
# 记录未使用索引的查询，帮助优化
log_queries_not_using_indexes = 1

# ============================================
# 二进制日志 - 用于主从复制和数据恢复
# ============================================
log_bin = mysql-bin
# ROW 格式更安全，记录实际数据变更
binlog_format = ROW
# binlog 保留 7 天（604800 秒）
binlog_expire_logs_seconds = 604800
# 单个 binlog 文件最大 100MB
max_binlog_size = 100M

# ============================================
# InnoDB 引擎优化
# ============================================
# 缓冲池大小，建议设为可用内存的 50-70%，容器中按需调整
innodb_buffer_pool_size = 256M
# 日志文件大小，影响崩溃恢复时间
innodb_log_file_size = 64M
# 每次事务提交都刷盘，保证数据安全（1=安全，2=性能）
innodb_flush_log_at_trx_commit = 1
# 每个表独立表空间，便于管理和回收空间
innodb_file_per_table = 1

# ============================================
# 连接设置
# ============================================
# 最大连接数，根据应用并发量调整
max_connections = 200
# 连接错误次数上限，防止暴力破解时锁定
max_connect_errors = 100000
# 非交互连接超时（秒）
wait_timeout = 600
# 交互连接超时（秒）
interactive_timeout = 600

# ============================================
# 内存与缓存
# ============================================
# 内存临时表最大值
tmp_table_size = 64M
max_heap_table_size = 64M
# 排序缓冲区，复杂排序时使用
sort_buffer_size = 2M
# JOIN 缓冲区
join_buffer_size = 2M
# 表缓存数量
table_open_cache = 2000

# ============================================
# 安全设置
# ============================================
# 跳过 DNS 反向解析，加快连接速度
skip-name-resolve = 1
# 禁用 LOAD DATA LOCAL，防止安全风险
local_infile = 0
# 禁用符号链接
symbolic-links = 0

[client]
default-character-set = utf8mb4
